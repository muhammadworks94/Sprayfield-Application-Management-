@model SAM.ViewModels.OperationalData.IrrigateCreateViewModel
@{
    ViewData["Title"] = "Create Irrigation Log";
    var facilities = ViewBag.Facilities as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
    var sprayfields = ViewBag.Sprayfields as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
}

<div class="mb-4">
    <p class="text-muted mb-0">Add a new irrigation log entry</p>
</div>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <form asp-action="IrrigateCreate" method="post">
                    @Html.AntiForgeryToken()
                    
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="form-section">
                        <div class="form-section-title">Basic Information</div>
                        
                        <input type="hidden" asp-for="CompanyId" />
                        
                        <div class="mb-3">
                            <label asp-for="FacilityId" class="form-label required"></label>
                            <div class="input-group">
                                <select asp-for="FacilityId" asp-items="facilities" class="form-select" id="facilitySelect">
                                    <option value="">-- Select Facility --</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary" id="btnNewFacility">
                                    <i class="bi bi-plus-circle"></i>
                                </button>
                            </div>
                            <span asp-validation-for="FacilityId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="SprayfieldId" class="form-label required"></label>
                            <select asp-for="SprayfieldId" asp-items="sprayfields" class="form-select">
                                <option value="">-- Select Sprayfield --</option>
                            </select>
                            <span asp-validation-for="SprayfieldId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="IrrigationDate" class="form-label required"></label>
                            <input asp-for="IrrigationDate" type="date" class="form-control" />
                            <span asp-validation-for="IrrigationDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Time & Duration</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="StartTime" class="form-label required"></label>
                                    <input asp-for="StartTime" type="time" class="form-control" />
                                    <span asp-validation-for="StartTime" class="text-danger"></span>
                                    <small class="form-text text-muted">Format: HH:MM (24‑hour time preferred for clarity).</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="EndTime" class="form-label required"></label>
                                    <input asp-for="EndTime" type="time" class="form-control" />
                                    <span asp-validation-for="EndTime" class="text-danger"></span>
                                    <small class="form-text text-muted">If irrigation runs past midnight, ensure the <strong>date</strong> reflects the start of the event.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="DurationHours" class="form-label"></label>
                                    <input asp-for="DurationHours" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="DurationHours" class="text-danger"></span>
                                    <small class="form-text text-muted">If left blank, the system will calculate duration from start and end times.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Flow & Volume</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="FlowRateGpm" class="form-label"></label>
                                    <input asp-for="FlowRateGpm" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="FlowRateGpm" class="text-danger"></span>
                                    <small class="form-text text-muted">Typical pump or meter flow in gallons per minute. Use averaged or metered values, not instantaneous spikes.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="TotalVolumeGallons" class="form-label"></label>
                                    <input asp-for="TotalVolumeGallons" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="TotalVolumeGallons" class="text-danger"></span>
                                    <small class="form-text text-muted">If blank, the system may derive volume from flow rate and duration. Override only with trusted meter totals.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="ApplicationRateInches" class="form-label"></label>
                                    <input asp-for="ApplicationRateInches" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="ApplicationRateInches" class="text-danger"></span>
                                    <small class="form-text text-muted">Depth applied to the sprayfield (inches). Ensure this aligns with permitted hydraulic loading limits.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Weather Conditions</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="WindSpeed" class="form-label"></label>
                                    <input asp-for="WindSpeed" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="WindSpeed" class="text-danger"></span>
                                    <small class="form-text text-muted">Wind speed at or near the field (mph). Verify against permit limits for drift control.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="WindDirection" class="form-label"></label>
                                    <input asp-for="WindDirection" class="form-control" />
                                    <span asp-validation-for="WindDirection" class="text-danger"></span>
                                    <small class="form-text text-muted">Use cardinal directions (e.g., N, SW) or degrees; be consistent with site practices.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="WeatherConditions" class="form-label"></label>
                                    <input asp-for="WeatherConditions" class="form-control" />
                                    <span asp-validation-for="WeatherConditions" class="text-danger"></span>
                                    <small class="form-text text-muted">Briefly note conditions that affect application (e.g., sunny, light rain, overcast, fog).</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Additional Information</div>
                        
                        <div class="mb-3">
                            <label asp-for="Operator" class="form-label"></label>
                            <input asp-for="Operator" class="form-control" />
                            <span asp-validation-for="Operator" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="Comments" class="form-label"></label>
                            <textarea asp-for="Comments" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Comments" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a asp-action="Irrigates" asp-route-companyId="@Model.CompanyId" asp-route-facilityId="@Model.FacilityId" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Create Irrigation Log
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <div class="alert alert-info ">
                    <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-1"></i>Irrigation Log Guidelines</h6>
                    <ul class="small mb-0 ps-3">
                        <li class="mb-1"><strong>Facility & Sprayfield</strong>: Choose the facility and specific sprayfield where irrigation occurred. This drives compliance calculations by field.</li>
                        <li class="mb-1"><strong>Irrigation Date</strong>: Use the date irrigation began. If the event spans multiple days, create separate entries when required by your permit.</li>
                        <li class="mb-1"><strong>Start / End Time</strong>: Enter the actual pump or valve on/off times. If there are multiple short runs, document the total continuous period or note details in <em>Comments</em>.</li>
                        <li class="mb-1"><strong>Duration (hours)</strong>: Let the system calculate when possible. If you override, verify the value is consistent with start/end times.</li>
                        <li class="mb-1"><strong>Flow Rate (gpm)</strong>: Use calibrated meter or pump curve values. If multiple pumps or zones were used, use a representative average or note details in <em>Comments</em>.</li>
                        <li class="mb-1"><strong>Total Volume (gallons)</strong>: Prefer metered totals over calculated values when available. Ensure volume aligns with field size and permitted loading limits.</li>
                        <li class="mb-1"><strong>Application Rate (inches)</strong>: Check that the depth applied over the event does not exceed agronomic or permit limits for the sprayfield.</li>
                        <li class="mb-1"><strong>Wind Speed & Direction</strong>: Record conditions at or near the time of application. High winds or unfavorable directions may require curtailing irrigation.</li>
                        <li class="mb-1"><strong>Weather Conditions</strong>: Note precipitation, temperature extremes, or saturated soil conditions that impact runoff or infiltration.</li>
                        <li class="mb-1"><strong>Operator</strong>: Identify the person responsible for this irrigation event. This may differ from the shift operator.</li>
                        <li><strong>Comments</strong>: Use this to explain unusual operations (bypasses, partial fields, equipment failures) or to document permit-related decisions (e.g., “Stopped early due to rising wind”).</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Facility Create Modal -->
<div class="modal fade" id="facilityCreateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Facility</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="facilityCreateForm" asp-action="FacilityCreate" asp-controller="SystemAdmin" method="post">
                    @Html.AntiForgeryToken()
                    @await Html.PartialAsync("~/Views/SystemAdmin/Partials/_FacilityCreateFormPartial.cshtml", new SAM.ViewModels.SystemAdmin.FacilityCreateViewModel { CompanyId = Model.CompanyId })
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" form="facilityCreateForm" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Create Facility
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        // Update sprayfields and company when facility changes (AJAX, no page reload)
        document.getElementById('facilitySelect')?.addEventListener('change', function () {
            var facilityId = this.value;
            var sprayfieldSelect = document.querySelector('select[name="SprayfieldId"]');
            var companyIdInput = document.querySelector('input[name="CompanyId"]');

            if (!sprayfieldSelect || !companyIdInput) return;

            // Clear current sprayfields
            sprayfieldSelect.innerHTML = '<option value="">-- Select Sprayfield --</option>';

            if (!facilityId) {
                // If facility cleared, also clear company id
                companyIdInput.value = '';
                return;
            }

            fetch('@Url.Action("GetSprayfieldsForFacility", "OperationalData")' + '?facilityId=' + encodeURIComponent(facilityId), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function (response) {
                if (!response.ok) {
                    throw new Error('Failed to load sprayfields');
                }
                return response.json();
            })
            .then(function (data) {
                // Set company id derived from facility
                if (data.companyId) {
                    companyIdInput.value = data.companyId;
                }

                // Populate sprayfields
                if (Array.isArray(data.sprayfields)) {
                    data.sprayfields.forEach(function (sf) {
                        var opt = document.createElement('option');
                        opt.value = sf.id;
                        opt.textContent = sf.name;
                        sprayfieldSelect.appendChild(opt);
                    });
                }
            })
            .catch(function (err) {
                console.error('Error loading sprayfields:', err);
            });
        });

        // Auto-load sprayfields if facility is already selected on page load
        document.addEventListener('DOMContentLoaded', function () {
            var facilitySelect = document.getElementById('facilitySelect');
            if (facilitySelect && facilitySelect.value) {
                var event = new Event('change');
                facilitySelect.dispatchEvent(event);
            }
        });

        // In-place Facility creation for admins/operators
        (function () {
            const button = document.getElementById('btnNewFacility');
            const modalElement = document.getElementById('facilityCreateModal');
            const select = document.getElementById('facilitySelect');

            if (!button || !modalElement || !select) return;

            const modal = new bootstrap.Modal(modalElement);
            const form = modalElement.querySelector('form');
            if (!form) return;

            button.addEventListener('click', function () {
                modal.show();
            });

            form.addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = new FormData(form);

                fetch('@Url.Action("FacilityCreate", "SystemAdmin")', {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                }).then(async response => {
                    const contentType = response.headers.get('content-type') || '';

                    if (contentType.includes('application/json')) {
                        const data = await response.json();
                        if (data.success) {
                            const option = document.createElement('option');
                            option.value = data.id;
                            option.textContent = data.name;
                            option.selected = true;
                            select.appendChild(option);
                            modal.hide();
                        }
                    } else {
                        const html = await response.text();
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = html;
                        const newFormContent = wrapper.firstElementChild;
                        if (newFormContent) {
                            const body = modalElement.querySelector('.modal-body');
                            body.innerHTML = '';
                            body.appendChild(newFormContent);
                        }
                    }
                }).catch(error => {
                    console.error('Error creating facility:', error);
                });
            });
        })();
    </script>
}

