@model SAM.ViewModels.OperationalData.OperatorLogEditViewModel
@using Microsoft.AspNetCore.Identity
@using SAM.Domain.Entities
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Edit Operator Log";
    var facilities = ViewBag.Facilities as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
    var user = await UserManager.GetUserAsync(User);
    var isGlobalAdmin = user != null && await UserManager.IsInRoleAsync(user, "admin");
}

<div class="mb-4">
    <p class="text-muted mb-0">Modify operator log information</p>
</div>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <form asp-action="OperatorLogEdit" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Id" />
                    
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="form-section">
                        <div class="form-section-title">Basic Information</div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="FacilityId" class="form-label required"></label>
                                    <select asp-for="FacilityId" asp-items="facilities" class="form-select">
                                        <option value="">-- Select Facility --</option>
                                    </select>
                                    <span asp-validation-for="FacilityId" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="LogDate" class="form-label required"></label>
                                    <input asp-for="LogDate" type="date" class="form-control" />
                                    <span asp-validation-for="LogDate" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="ArrivalTime" class="form-label required"></label>
                                    <input asp-for="ArrivalTime" type="time" class="form-control" />
                                    <span asp-validation-for="ArrivalTime" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="OperatorName" class="form-label"></label>
                                    <div class="form-control-plaintext">
                                        @Model.OperatorName
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="WeatherConditions" class="form-label"></label>
                                    <select asp-for="WeatherConditions" class="form-select">
                                        <option value="">-- Select Weather --</option>
                                        <option value="C">Clear (C)</option>
                                        <option value="CL">Cloudy (CL)</option>
                                        <option value="PC">Partly Cloudy (PC)</option>
                                        <option value="R">Rain (R)</option>
                                        <option value="SL">Sleet (SL)</option>
                                        <option value="SN">Snow (SN)</option>
                                    </select>
                                    <span asp-validation-for="WeatherConditions" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label asp-for="TimeOnSiteHours" class="form-label"></label>
                                    <input asp-for="TimeOnSiteHours" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="TimeOnSiteHours" class="text-danger"></span>
                                    <small class="form-text text-muted">Enter total time on site as hours in decimal format (e.g., 1.5 for 1½ hours).</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Operational Details</div>
                        
                        <div class="mb-3">
                            <label asp-for="MaintenancePerformed" class="form-label"></label>
                            <textarea asp-for="MaintenancePerformed" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="MaintenancePerformed" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="EquipmentInspected" class="form-label"></label>
                            <textarea asp-for="EquipmentInspected" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="EquipmentInspected" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="IssuesNoted" class="form-label"></label>
                            <textarea asp-for="IssuesNoted" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="IssuesNoted" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="CorrectiveActions" class="form-label"></label>
                            <textarea asp-for="CorrectiveActions" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="CorrectiveActions" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="NextShiftNotes" class="form-label"></label>
                            <textarea asp-for="NextShiftNotes" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="NextShiftNotes" class="text-danger"></span>
                        </div>
                    </div>

                    <input type="hidden" asp-for="CompanyId" />

                    <div class="d-flex justify-content-end gap-2">
                        <a asp-action="OperatorLogDetails" asp-route-id="@Model.Id" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Log
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <div class="alert alert-info ">
                    <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-1"></i>Editing Operator Logs</h6>
                    <ul class="small mb-0 ps-3">
                        <li class="mb-1"><strong>Facility</strong>: Confirm the facility is correct before saving; changing facilities will move this log to a different site’s history.</li>
                        <li class="mb-1"><strong>Log Date</strong>: Adjust only if the log was entered on the wrong calendar date for the visit.</li>
                        <li class="mb-1"><strong>Operator Name</strong>: This is recorded from the operator account that created or last took responsibility for the log and is not edited directly.</li>
                        <li class="mb-1"><strong>Arrival Time</strong>: Keep the recorded arrival time accurate to support timelines and investigations.</li>
                        <li class="mb-1"><strong>Time on Site</strong>: Update hours on site if the duration was misestimated or work was extended.</li>
                        <li class="mb-1"><strong>Weather Conditions</strong>: Update the selected weather code if conditions were mischaracterized or materially affected operations.</li>
                        <li class="mb-1"><strong>Maintenance Performed</strong>: Add missing details such as work order numbers, equipment IDs, and parts replaced so maintenance history is clear.</li>
                        <li class="mb-1"><strong>Equipment Inspected</strong>: Clarify what was checked and what you observed (e.g., “P-1 running smooth, no leaks; blower B-2 vibration normal”).</li>
                        <li class="mb-1"><strong>Issues Noted</strong>: Ensure all significant alarms, excursions, or safety concerns are documented—even if resolved after the shift.</li>
                        <li class="mb-1"><strong>Corrective Actions</strong>: Describe not only what you did, but also when and why (setpoint changes, callouts, temporary bypass, etc.).</li>
                        <li class="mb-1"><strong>Next Shift Notes</strong>: Use this to improve handoffs—call out trends to watch, pending maintenance, lab samples due, or equipment in manual mode.</li>
                        <li><strong>Revision discipline</strong>: Avoid rewriting history; instead, add clarifications or corrections so future reviewers can see how understanding evolved over time.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        (function () {
            document.addEventListener('DOMContentLoaded', function () {
                var arrivalInput = document.querySelector('input[name="ArrivalTime"]');

                if (!arrivalInput) {
                    return;
                }

                if (typeof flatpickr === 'function') {
                    flatpickr(arrivalInput, {
                        enableTime: true,
                        noCalendar: true,
                        dateFormat: "H:i",
                        time_24hr: true,
                        allowInput: true
                    });
                }
            });
        })();
    </script>
}

