@model SAM.ViewModels.OperationalData.IrrigateEditViewModel
@{
    ViewData["Title"] = "Edit Irrigation Log";
    var facilities = ViewBag.Facilities as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
    var sprayfields = ViewBag.Sprayfields as Microsoft.AspNetCore.Mvc.Rendering.SelectList;
}

<div class="mb-4">
    <p class="text-muted mb-0">Modify irrigation log information</p>
</div>

<div class="card">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8">
                <form asp-action="IrrigateEdit" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" asp-for="Id" />
                    <input type="hidden" asp-for="CompanyId" />
                    
                    <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>

                    <div class="form-section">
                        <div class="form-section-title">Basic Information</div>
                        
                        <div class="mb-3">
                            <label asp-for="FacilityId" class="form-label required"></label>
                            <select asp-for="FacilityId" asp-items="facilities" class="form-select" id="facilitySelect">
                                <option value="">-- Select Facility --</option>
                            </select>
                            <span asp-validation-for="FacilityId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="SprayfieldId" class="form-label required"></label>
                            <select asp-for="SprayfieldId" asp-items="sprayfields" class="form-select">
                                <option value="">-- Select Sprayfield --</option>
                            </select>
                            <span asp-validation-for="SprayfieldId" class="text-danger"></span>
                        </div>

                        <div class="mb-3">
                            <label asp-for="IrrigationDate" class="form-label required"></label>
                            <input asp-for="IrrigationDate" type="date" class="form-control" />
                            <span asp-validation-for="IrrigationDate" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Time & Duration</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="StartTime" class="form-label required"></label>
                                    <input asp-for="StartTime" type="time" class="form-control" />
                                    <span asp-validation-for="StartTime" class="text-danger"></span>
                                    <small class="form-text text-muted">Use 24-hour time (HH:MM) via the time picker.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="EndTime" class="form-label required"></label>
                                    <input asp-for="EndTime" type="time" class="form-control" />
                                    <span asp-validation-for="EndTime" class="text-danger"></span>
                                    <small class="form-text text-muted">If End Time is earlier than Start Time, it will be treated as the next day for duration.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="DurationHours" class="form-label"></label>
                                    <input asp-for="DurationHours" type="number" step="0.01" class="form-control" readonly />
                                    <span asp-validation-for="DurationHours" class="text-danger"></span>
                                    <small class="form-text text-muted">Duration (hours) is automatically calculated from Start and End Time.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Flow & Volume</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="FlowRateGpm" class="form-label"></label>
                                    <input asp-for="FlowRateGpm" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="FlowRateGpm" class="text-danger"></span>
                                    <small class="form-text text-muted">Update only if new meter data or calibration results show the original rate was inaccurate.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="TotalVolumeGallons" class="form-label"></label>
                                    <input asp-for="TotalVolumeGallons" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="TotalVolumeGallons" class="text-danger"></span>
                                    <small class="form-text text-muted">Use final metered volume when available; avoid double‑counting previously reported totals.</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="ApplicationRateInches" class="form-label"></label>
                                    <input asp-for="ApplicationRateInches" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="ApplicationRateInches" class="text-danger"></span>
                                    <small class="form-text text-muted">If you change this, verify that updated values still comply with field loading limits.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Weather Conditions</div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="PrecipitationIn" class="form-label"></label>
                                    <input asp-for="PrecipitationIn" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="PrecipitationIn" class="text-danger"></span>
                                    <small class="form-text text-muted">Measured precipitation during the event (inches).</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="TemperatureF" class="form-label"></label>
                                    <input asp-for="TemperatureF" type="number" step="0.01" class="form-control" />
                                    <span asp-validation-for="TemperatureF" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label asp-for="WeatherConditions" class="form-label"></label>
                                    <select asp-for="WeatherConditions" class="form-select">
                                        <option value="">-- Select Weather --</option>
                                        <option value="C">Clear (C)</option>
                                        <option value="CL">Cloudy (CL)</option>
                                        <option value="PC">Partly Cloudy (PC)</option>
                                        <option value="R">Rain (R)</option>
                                        <option value="SL">Sleet (SL)</option>
                                        <option value="SN">Snow (SN)</option>
                                    </select>
                                    <span asp-validation-for="WeatherConditions" class="text-danger"></span>
                                    <small class="form-text text-muted">Select weather using descriptions; the code in parentheses is used for reporting.</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <div class="form-section-title">Additional Information</div>
                        
                        <div class="mb-3">
                            <label asp-for="Comments" class="form-label"></label>
                            <textarea asp-for="Comments" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Comments" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a asp-action="IrrigateDetails" asp-route-id="@Model.Id" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Update Irrigation Log
                        </button>
                    </div>
                </form>
            </div>

            <div class="col-lg-4">
                <div class="alert alert-info ">
                    <h6 class="fw-bold mb-3"><i class="bi bi-info-circle me-1"></i>Editing Irrigation Logs</h6>
                    <ul class="small mb-0 ps-3">
                        <li class="mb-1"><strong>Facility & Sprayfield</strong>: Confirm these match where the irrigation actually occurred. Changing them will move this record to a different field’s history.</li>
                        <li class="mb-1"><strong>Irrigation Date</strong>: Adjust only to correct data entry errors. Do not change the date to “group” events for reporting.</li>
                        <li class="mb-1"><strong>Times & Duration</strong>: Ensure that start/end times and duration remain logically consistent. Document any corrections or re‑estimations in <em>Comments</em>.</li>
                        <li class="mb-1"><strong>Flow Rate & Volume</strong>: Use updated meter readings or recalculated values when you discover an error. Keep a clear audit trail of why numbers changed.</li>
                        <li class="mb-1"><strong>Application Rate</strong>: If recalculated, confirm that the corrected rate still complies with field‑specific permit limits and agronomic needs.</li>
                        <li class="mb-1"><strong>Weather Data</strong>: Only adjust if original observations were clearly wrong or incomplete. Weather data supports defensibility of application decisions.</li>
                        <li class="mb-1"><strong>Operator</strong>: Verify the responsible operator or team lead is correctly identified for this event.</li>
                        <li><strong>Comments</strong>: Use comments to explain why any key values were edited (e.g., “Updated volume based on final meter total,” “Corrected field selection from SF‑1 to SF‑3”). This is important for audits and regulatory review.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        (function () {
            function computeDuration() {
                var startInput = document.querySelector('input[name="StartTime"]');
                var endInput = document.querySelector('input[name="EndTime"]');
                var durationInput = document.querySelector('input[name="DurationHours"]');

                if (!startInput || !endInput || !durationInput) {
                    return;
                }

                var startStr = startInput.value;
                var endStr = endInput.value;

                if (!startStr || !endStr) {
                    durationInput.value = '';
                    return;
                }

                var startParts = startStr.split(':');
                var endParts = endStr.split(':');
                if (startParts.length < 2 || endParts.length < 2) {
                    durationInput.value = '';
                    return;
                }

                var startHours = parseInt(startParts[0], 10);
                var startMinutes = parseInt(startParts[1], 10);
                var endHours = parseInt(endParts[0], 10);
                var endMinutes = parseInt(endParts[1], 10);

                if (isNaN(startHours) || isNaN(startMinutes) || isNaN(endHours) || isNaN(endMinutes)) {
                    durationInput.value = '';
                    return;
                }

                var referenceDate = new Date();
                var startDate = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate(), startHours, startMinutes, 0, 0);
                var endDate = new Date(referenceDate.getFullYear(), referenceDate.getMonth(), referenceDate.getDate(), endHours, endMinutes, 0, 0);

                if (endDate < startDate) {
                    // Treat end as next day for cross-midnight events
                    endDate.setDate(endDate.getDate() + 1);
                }

                var diffMs = endDate.getTime() - startDate.getTime();
                if (diffMs <= 0) {
                    durationInput.value = '';
                    return;
                }

                var hours = diffMs / (1000 * 60 * 60);
                durationInput.value = hours.toFixed(2);
            }

            document.addEventListener('DOMContentLoaded', function () {
                var startInput = document.querySelector('input[name="StartTime"]');
                var endInput = document.querySelector('input[name="EndTime"]');

                if (typeof flatpickr === 'function') {
                    if (startInput) {
                        flatpickr(startInput, {
                            enableTime: true,
                            noCalendar: true,
                            dateFormat: "H:i",
                            time_24hr: true,
                            allowInput: true,
                            onChange: computeDuration,
                            onClose: computeDuration
                        });
                    }

                    if (endInput) {
                        flatpickr(endInput, {
                            enableTime: true,
                            noCalendar: true,
                            dateFormat: "H:i",
                            time_24hr: true,
                            allowInput: true,
                            onChange: computeDuration,
                            onClose: computeDuration
                        });
                    }
                } else {
                    if (startInput) {
                        startInput.addEventListener('change', computeDuration);
                    }
                    if (endInput) {
                        endInput.addEventListener('change', computeDuration);
                    }
                }

                // Initial calculation in case values are pre-populated
                computeDuration();
            });
        })();

        // Update sprayfields when facility changes
        document.getElementById('facilitySelect')?.addEventListener('change', function() {
            var facilityId = this.value;
            if (facilityId) {
                // Reload page with new facility filter
                window.location.href = '@Url.Action("IrrigateEdit", new { id = Model.Id })' + '&facilityId=' + facilityId;
            }
        });
    </script>
}

