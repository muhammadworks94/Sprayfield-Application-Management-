@{
    ViewData["Title"] = "Company Management";
    var isGlobalAdmin = ViewBag.IsGlobalAdmin as bool? ?? false;
    var activeTab = ViewBag.ActiveTab as string ?? "companies";
    var companies = ViewBag.Companies as IEnumerable<SAM.ViewModels.SystemAdmin.CompanyViewModel> ?? Enumerable.Empty<SAM.ViewModels.SystemAdmin.CompanyViewModel>();
    var companyRequests = ViewBag.CompanyRequests as IEnumerable<SAM.ViewModels.UserManagement.CompanyRequestViewModel> ?? Enumerable.Empty<SAM.ViewModels.UserManagement.CompanyRequestViewModel>();
    var filterViewModel = ViewBag.FilterViewModel as SAM.ViewModels.Common.FilterViewModel;
    var validCompanyIds = ViewBag.ValidCompanyIds as Dictionary<Guid, bool> ?? new Dictionary<Guid, bool>();
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <p class="text-muted mb-0">Manage companies and review company registration requests</p>
    </div>
</div>

<!-- Bootstrap Tabs -->
<ul class="nav nav-tabs mb-4" id="companyManagementTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "companies" ? "active" : "")" 
                id="companies-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#companies" 
                type="button" 
                role="tab" 
                aria-controls="companies" 
                aria-selected="@(activeTab == "companies" ? "true" : "false")">
            <i class="bi bi-building me-1"></i>Companies
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link @(activeTab == "requests" ? "active" : "")" 
                id="requests-tab" 
                data-bs-toggle="tab" 
                data-bs-target="#requests" 
                type="button" 
                role="tab" 
                aria-controls="requests" 
                aria-selected="@(activeTab == "requests" ? "true" : "false")">
            <i class="bi bi-building-add me-1"></i>Company Requests
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="companyManagementTabContent">
    <!-- Companies Tab -->
    <div class="tab-pane fade @(activeTab == "companies" ? "show active" : "")" 
         id="companies" 
         role="tabpanel" 
         aria-labelledby="companies-tab">
        
        @if (filterViewModel != null)
        {
            @await Html.PartialAsync("Partials/_Filter", filterViewModel)
        }

        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-5">
                    <h4 class="mb-0"> Companies</h4>
                    <div class="d-flex">
                        <div class="btn-group me-2" role="group" aria-label="View mode toggle">
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary active"
                                    id="companiesTableViewBtn">
                                <i class="bi bi-table"></i> Table
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary"
                                    id="companiesCardViewBtn">
                                <i class="bi bi-grid-3x3-gap"></i> Cards
                            </button>
                        </div>
                        @if (isGlobalAdmin)
                        {
                            <a asp-controller="CompanyManagement" asp-action="CompanyCreate" class="btn btn-sm btn-primary">
                                <i class="bi bi-plus-circle"></i> Add Company
                            </a>
                        }
                    </div>
                </div>
                @if (companies.Any())
                {
                    <div id="companiesTableView" class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-building"></i> Company Name</th>
                                    <th><i class="bi bi-envelope"></i> Contact Email</th>
                                    <th><i class="bi bi-phone"></i> Phone</th>
                                    <th><i class="bi bi-globe"></i> Website</th>
                                    <th><i class="bi bi-check-circle"></i> Active</th>
                                    <th><i class="bi bi-shield-check"></i> Verified</th>
                                    @if (isGlobalAdmin)
                                    {
                                        <th class="table-actions"><i class="bi bi-gear"></i> Actions</th>
                                    }
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var company in companies)
                                {
                                    <tr>
                                        <td>
                                            <a asp-controller="CompanyManagement" asp-action="CompanyDetails" asp-route-id="@company.Id" class="text-decoration-none">
                                                @company.Name
                                            </a>
                                        </td>
                                        <td>@company.ContactEmail</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(company.PhoneNumber))
                                            {
                                                @company.PhoneNumber
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(company.Website))
                                            {
                                                <a href="@company.Website" target="_blank" rel="noopener noreferrer">
                                                    @company.Website
                                                </a>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            @if (company.IsActive)
                                            {
                                                <span class="badge bg-success">
                                                    <i class="bi bi-check-circle me-1"></i>Active
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-x-circle me-1"></i>Inactive
                                                </span>
                                            }
                                        </td>
                                        <td>
                                            @if (company.IsVerified)
                                            {
                                                <span class="badge bg-success">
                                                    <i class="bi bi-shield-check me-1"></i>Verified
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">
                                                    <i class="bi bi-shield-x me-1"></i>Unverified
                                                </span>
                                            }
                                        </td>
                                        @if (isGlobalAdmin)
                                        {
                                            <td class="table-actions">
                                                <a asp-controller="CompanyManagement" asp-action="CompanyEdit" asp-route-id="@company.Id" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </a>
                                                <a asp-controller="CompanyManagement" asp-action="CompanyDelete" asp-route-id="@company.Id" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i> Delete
                                                </a>
                                            </td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div id="companiesCardView" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 d-none">
                        @foreach (var company in companies)
                        {
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-header-light d-flex justify-content-between">
                                        <h6 class="mb-0">
                                            <a asp-controller="CompanyManagement" asp-action="CompanyDetails" asp-route-id="@company.Id" class="text-decoration-none">
                                                @company.Name
                                            </a>
                                        </h6>
                                    </div>
                                    <div class="card-body d-flex flex-column">
                                        <dl class="row small mb-3">
                                            <dt class="col-4"><i class="bi bi-envelope me-1"></i>Email</dt>
                                            <dd class="col-8 mb-1">@company.ContactEmail</dd>

                                            @if (!string.IsNullOrEmpty(company.PhoneNumber))
                                            {
                                                <dt class="col-4"><i class="bi bi-phone me-1"></i>Phone</dt>
                                                <dd class="col-8 mb-1">@company.PhoneNumber</dd>
                                            }

                                            @if (!string.IsNullOrEmpty(company.Website))
                                            {
                                                <dt class="col-4"><i class="bi bi-globe me-1"></i>Website</dt>
                                                <dd class="col-8 mb-1">
                                                    <a href="@company.Website" target="_blank" rel="noopener noreferrer" class="text-truncate d-inline-block" style="max-width: 100%;">
                                                        @company.Website
                                                    </a>
                                                </dd>
                                            }

                                            <dt class="col-4"><i class="bi bi-calendar me-1"></i>Created</dt>
                                            <dd class="col-8 mb-1">@company.CreatedDate.ToString("MM/dd/yyyy")</dd>

                                            <dt class="col-4">
                                                @if (company.IsVerified)
                                                {
                                                    <i class="bi bi-shield-check me-1"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-shield-x me-1 text-danger"></i>
                                                }
                                                Verified
                                            </dt>
                                            <dd class="col-8 mb-1">@(company.IsVerified ? "Yes" : "No")</dd>
                                            
                                            <dt class="col-4">
                                                @if (company.IsActive)
                                                {
                                                    <i class="bi bi-check-circle me-1 text-success"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-x-circle me-1 text-danger"></i>
                                                }
                                                Active
                                            </dt>
                                            <dd class="col-8 mb-1">@(company.IsActive ? "Yes" : "No")</dd>
                                        </dl>

                                        <div class="mt-auto d-flex justify-content-end">
                                            @if (isGlobalAdmin)
                                            {
                                                <a asp-controller="CompanyManagement" asp-action="CompanyEdit" asp-route-id="@company.Id" class="btn btn-sm btn-outline-primary me-2">
                                                    <i class="bi bi-pencil"></i> Edit
                                                </a>
                                                <a asp-controller="CompanyManagement" asp-action="CompanyDelete" asp-route-id="@company.Id" class="btn btn-sm btn-outline-danger">
                                                    <i class="bi bi-trash"></i> Delete
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--gray-400);"></i>
                        <p class="text-muted mt-3">No companies found.</p>
                        @if (isGlobalAdmin)
                        {
                            <a asp-controller="CompanyManagement" asp-action="CompanyCreate" class="btn btn-primary mt-2">
                                <i class="bi bi-plus-circle"></i> Create First Company
                            </a>
                        }
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Company Requests Tab -->
    <div class="tab-pane fade @(activeTab == "requests" ? "show active" : "")" 
         id="requests" 
         role="tabpanel" 
         aria-labelledby="requests-tab">
        
        <div class="card">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between mb-5">
                    <h4 class="mb-0"> Company Requests</h4>
                        <div class="btn-group me-2" role="group" aria-label="View mode toggle">
                            <button type="button"
                                    class="btn btn-outline-secondary btn-sm active"
                                    id="companyRequestsTableViewBtn">
                                <i class="bi bi-table"></i> Table
                            </button>
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary"
                                    id="companyRequestsCardViewBtn">
                                <i class="bi bi-grid-3x3-gap"></i> Cards
                            </button>
                        </div>
                </div>
                @if (companyRequests.Any())
                {
                    <div id="companyRequestsTableView" class="table-responsive">
                        <table class="table irrigates-table">
                            <thead>
                                <tr>
                                    <th><i class="bi bi-building"></i> Company Name</th>
                                    <th><i class="bi bi-person"></i> Requester</th>
                                    <th><i class="bi bi-envelope"></i> Requester Email</th>
                                    <th><i class="bi bi-phone"></i> Contact</th>
                                    <th><i class="bi bi-info-circle"></i> Status</th>
                                    <th><i class="bi bi-calendar"></i> Created Date</th>
                                    <th class="table-actions"><i class="bi bi-gear"></i> Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var request in companyRequests)
                                {
                                    <tr>
                                        <td>
                                            <strong>@request.CompanyName</strong>
                                            @if (!string.IsNullOrEmpty(request.Description))
                                            {
                                                <br />
                                                <small class="text-muted">@request.Description</small>
                                            }
                                        </td>
                                        <td>@request.RequesterFullName</td>
                                        <td>@request.RequesterEmail</td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(request.PhoneNumber))
                                            {
                                                <div>@request.PhoneNumber</div>
                                            }
                                            @if (!string.IsNullOrEmpty(request.Website))
                                            {
                                                <div><a href="@request.Website" target="_blank">@request.Website</a></div>
                                            }
                                        </td>
                                        <td>
                                            @if (request.Status == SAM.Domain.Enums.RequestStatusEnum.Pending)
                                            {
                                                <span class="badge bg-warning">Pending</span>
                                            }
                                            else if (request.CreatedCompanyId.HasValue)
                                            {
                                                <span class="badge bg-success">Approved</span>
                                                <br />
                                                <small class="text-muted">Company Created</small>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger">Rejected</span>
                                                @if (!string.IsNullOrEmpty(request.RejectionReason))
                                                {
                                                    <br />
                                                    <small class="text-muted">@request.RejectionReason</small>
                                                }
                                            }
                                        </td>
                                        <td>@request.CreatedDate.ToString("MM/dd/yyyy")</td>
                                        <td class="table-actions">
                                            @if (request.Status == SAM.Domain.Enums.RequestStatusEnum.Pending)
                                            {
                                                <a asp-action="CompanyRequestApprove" asp-route-id="@request.Id" class="btn btn-sm btn-outline-success">
                                                    <i class="bi bi-check-circle"></i> Approve
                                                </a>
                                                <button type="button" class="btn btn-sm btn-outline-danger" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#rejectCompanyRequestModal"
                                                        data-request-id="@request.Id"
                                                        data-request-name="@request.CompanyName">
                                                    <i class="bi bi-x-circle"></i> Reject
                                                </button>
                                            }
                                            else if (request.CreatedCompanyId.HasValue)
                                            {
                                                @if (validCompanyIds.ContainsKey(request.CreatedCompanyId.Value) && validCompanyIds[request.CreatedCompanyId.Value])
                                                {
                                                    <a asp-controller="SystemAdmin" asp-action="CompanyDetails" asp-route-id="@request.CreatedCompanyId" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i> View Company
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary" title="The company associated with this request has been deleted.">
                                                        <i class="bi bi-exclamation-triangle"></i> Company Deleted
                                                    </span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div id="companyRequestsCardView" class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-3 d-none">
                        @foreach (var request in companyRequests)
                        {
                            <div class="col">
                                <div class="card h-100 shadow-sm">
                                    <h6 class="mb-0 card-header-light">@request.CompanyName</h6>
                                    <div class="card-body d-flex flex-column">
                                        @if (!string.IsNullOrEmpty(request.Description))
                                        {
                                            <small class="text-muted d-block mb-2">@request.Description</small>
                                        }

                                        <dl class="row small mb-3">
                                            <dt class="col-5"><i class="bi bi-person me-1"></i>Requester</dt>
                                            <dd class="col-7 mb-1">@request.RequesterFullName</dd>

                                            <dt class="col-5"><i class="bi bi-envelope me-1"></i>Email</dt>
                                            <dd class="col-7 mb-1">@request.RequesterEmail</dd>

                                            <dt class="col-5"><i class="bi bi-phone me-1"></i>Contact</dt>
                                            <dd class="col-7 mb-1">@request.PhoneNumber</dd>

                                            @if (!string.IsNullOrEmpty(request.Website))
                                            {
                                                <dt class="col-5"><i class="bi bi-globe me-1"></i>Website</dt>
                                                <dd class="col-7 mb-1"><a href="@request.Website" target="_blank">@request.Website</a></dd>
                                            }

                                            <dt class="col-5"><i class="bi bi-info-circle me-1"></i>Status</dt>
                                            <dd class="col-7 mb-1">
                                                @if (request.Status == SAM.Domain.Enums.RequestStatusEnum.Pending)
                                                {
                                                    <span class="badge bg-warning">Pending</span>
                                                }
                                                else if (request.CreatedCompanyId.HasValue)
                                                {
                                                    <span class="badge bg-success">Approved</span>
                                                    <br />
                                                    <small class="text-muted">Company Created</small>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-danger">Rejected</span>
                                                    @if (!string.IsNullOrEmpty(request.RejectionReason))
                                                    {
                                                        <br />
                                                        <small class="text-muted">@request.RejectionReason</small>
                                                    }
                                                }
                                            </dd>

                                            <dt class="col-5"><i class="bi bi-calendar me-1"></i>Created</dt>
                                            <dd class="col-7 mb-1">@request.CreatedDate.ToString("MM/dd/yyyy")</dd>
                                        </dl>

                                        <div class="mt-auto d-flex justify-content-end">
                                            @if (request.Status == SAM.Domain.Enums.RequestStatusEnum.Pending)
                                            {
                                                <div class="btn-group">
                                                    <a asp-action="CompanyRequestApprove" asp-route-id="@request.Id" class="btn btn-sm btn-outline-success">
                                                        <i class="bi bi-check-circle"></i> Approve
                                                    </a>
                                                    <button type="button" class="btn btn-sm btn-outline-danger" 
                                                            data-bs-toggle="modal" 
                                                            data-bs-target="#rejectCompanyRequestModal"
                                                            data-request-id="@request.Id"
                                                            data-request-name="@request.CompanyName">
                                                        <i class="bi bi-x-circle"></i> Reject
                                                    </button>
                                                </div>
                                            }
                                            else if (request.CreatedCompanyId.HasValue)
                                            {
                                                @if (validCompanyIds.ContainsKey(request.CreatedCompanyId.Value) && validCompanyIds[request.CreatedCompanyId.Value])
                                                {
                                                    <a asp-controller="SystemAdmin" asp-action="CompanyDetails" asp-route-id="@request.CreatedCompanyId" class="btn btn-sm btn-outline-primary">
                                                        <i class="bi bi-eye"></i> View Company
                                                    </a>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-secondary" title="The company associated with this request has been deleted.">
                                                        <i class="bi bi-exclamation-triangle"></i> Company Deleted
                                                    </span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted small">No actions</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--gray-400);"></i>
                        <p class="text-muted mt-3">No company requests found.</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Reject Company Request Modal -->
<div class="modal fade" id="rejectCompanyRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Reject Company Request</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="rejectCompanyRequestForm" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <p>Are you sure you want to reject the company request for <strong id="rejectCompanyName"></strong>?</p>
                    <div class="mb-3">
                        <label for="rejectCompanyReason" class="form-label">Reason (optional):</label>
                        <textarea name="reason" id="rejectCompanyReason" class="form-control" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Reject Request</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Tab switching - update URL without reload
            const tabButtons = document.querySelectorAll('#companyManagementTabs button[data-bs-toggle="tab"]');
            tabButtons.forEach(button => {
                button.addEventListener('shown.bs.tab', function (event) {
                    const tabId = event.target.getAttribute('data-bs-target').substring(1);
                    const url = new URL(window.location);
                    url.searchParams.set('tab', tabId);
                    window.history.pushState({}, '', url);
                });
            });

            // Companies view mode toggle
            const companiesTableBtn = document.getElementById('companiesTableViewBtn');
            const companiesCardBtn = document.getElementById('companiesCardViewBtn');
            const companiesTableView = document.getElementById('companiesTableView');
            const companiesCardView = document.getElementById('companiesCardView');
            const companiesStorageKey = 'companiesViewMode';

            function setCompaniesViewMode(mode) {
                const isTable = mode === 'table';

                if (isTable) {
                    companiesTableView?.classList.remove('d-none');
                    companiesCardView?.classList.add('d-none');
                    companiesTableBtn?.classList.add('active');
                    companiesCardBtn?.classList.remove('active');
                } else {
                    companiesTableView?.classList.add('d-none');
                    companiesCardView?.classList.remove('d-none');
                    companiesTableBtn?.classList.remove('active');
                    companiesCardBtn?.classList.add('active');
                }

                if (window.localStorage) {
                    localStorage.setItem(companiesStorageKey, mode);
                }
            }

            const savedCompaniesMode = window.localStorage ? localStorage.getItem(companiesStorageKey) : null;
            setCompaniesViewMode(savedCompaniesMode === 'card' ? 'card' : 'table');

            companiesTableBtn?.addEventListener('click', function () {
                setCompaniesViewMode('table');
            });

            companiesCardBtn?.addEventListener('click', function () {
                setCompaniesViewMode('card');
            });

            // Company Requests view mode toggle
            const requestsTableBtn = document.getElementById('companyRequestsTableViewBtn');
            const requestsCardBtn = document.getElementById('companyRequestsCardViewBtn');
            const requestsTableView = document.getElementById('companyRequestsTableView');
            const requestsCardView = document.getElementById('companyRequestsCardView');
            const requestsStorageKey = 'companyRequestsViewMode';

            function setRequestsViewMode(mode) {
                const isTable = mode === 'table';

                if (isTable) {
                    requestsTableView?.classList.remove('d-none');
                    requestsCardView?.classList.add('d-none');
                    requestsTableBtn?.classList.add('active');
                    requestsCardBtn?.classList.remove('active');
                } else {
                    requestsTableView?.classList.add('d-none');
                    requestsCardView?.classList.remove('d-none');
                    requestsTableBtn?.classList.remove('active');
                    requestsCardBtn?.classList.add('active');
                }

                if (window.localStorage) {
                    localStorage.setItem(requestsStorageKey, mode);
                }
            }

            const savedRequestsMode = window.localStorage ? localStorage.getItem(requestsStorageKey) : null;
            setRequestsViewMode(savedRequestsMode === 'card' ? 'card' : 'table');

            requestsTableBtn?.addEventListener('click', function () {
                setRequestsViewMode('table');
            });

            requestsCardBtn?.addEventListener('click', function () {
                setRequestsViewMode('card');
            });

            // Reject modal handling
            const rejectModal = document.getElementById('rejectCompanyRequestModal');
            if (rejectModal) {
                rejectModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const requestId = button.getAttribute('data-request-id');
                    const requestName = button.getAttribute('data-request-name');
                    
                    const nameElement = rejectModal.querySelector('#rejectCompanyName');
                    if (nameElement) {
                        nameElement.textContent = requestName;
                    }
                    
                    const form = rejectModal.querySelector('#rejectCompanyRequestForm');
                    if (form) {
                        const baseUrl = '@Url.Action("CompanyRequestReject", "CompanyManagement")';
                        form.action = baseUrl + '/' + requestId;
                    }
                    
                    const reasonTextarea = rejectModal.querySelector('#rejectCompanyReason');
                    if (reasonTextarea) {
                        reasonTextarea.value = '';
                    }
                });
            }
        })();
    </script>
}

