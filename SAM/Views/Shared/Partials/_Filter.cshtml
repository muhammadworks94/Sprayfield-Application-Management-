@model SAM.ViewModels.Common.FilterViewModel
@{
    var hasFields = Model.Fields != null && Model.Fields.Any();
    var showFilter = hasFields || Model.EnableSearch;
}

@if (showFilter)
{
    <div class="card mb-3">
        <div class="card-body">
            @{
                var formAction = !string.IsNullOrEmpty(Model.ActionName) && !string.IsNullOrEmpty(Model.ControllerName)
                    ? Url.Action(Model.ActionName, Model.ControllerName)
                    : string.Empty;
            }
            <form method="get" 
                  id="filterForm" 
                  class="row g-3"
                  action="@(string.IsNullOrEmpty(formAction) ? "" : formAction)">
                @if (hasFields)
                {
                    @foreach (var field in Model.Fields)
                    {
                        <div class="@field.ColumnClass">
                            <label for="@field.Name" class="form-label">
                                @if (!string.IsNullOrEmpty(field.IconClass))
                                {
                                    <i class="@field.IconClass me-1"></i>
                                }
                                @field.Label:
                            </label>
                            @if (field.Type == SAM.ViewModels.Common.FilterFieldType.Dropdown && field.Options != null)
                            {
                                <select name="@field.Name" id="@field.Name" class="form-select filter-dropdown" data-submit-on-change="@field.SubmitOnChange.ToString().ToLower()">
                                    <option value="">All</option>
                                    @foreach (var option in field.Options)
                                    {
                                        var isSelected = false;
                                        if (field.Value != null)
                                        {
                                            var valueStr = field.Value.ToString();
                                            // Handle Guid comparison - compare both as strings, case-insensitive
                                            isSelected = string.Equals(option.Value, valueStr, StringComparison.OrdinalIgnoreCase);
                                        }
                                        @if (isSelected)
                                        {
                                            <option value="@option.Value" selected="selected">@option.Text</option>
                                        }
                                        else
                                        {
                                            <option value="@option.Value">@option.Text</option>
                                        }
                                    }
                                </select>
                            }
                            else if (field.Type == SAM.ViewModels.Common.FilterFieldType.Text)
                            {
                                <input type="text" 
                                       name="@field.Name" 
                                       id="@field.Name" 
                                       class="form-control" 
                                       value="@field.Value" 
                                       placeholder="@field.Label" />
                            }
                            else if (field.Type == SAM.ViewModels.Common.FilterFieldType.Date)
                            {
                                <input type="date" 
                                       name="@field.Name" 
                                       id="@field.Name" 
                                       class="form-control" 
                                       value="@field.Value" />
                            }
                            else if (field.Type == SAM.ViewModels.Common.FilterFieldType.Number)
                            {
                                <input type="number" 
                                       name="@field.Name" 
                                       id="@field.Name" 
                                       class="form-control" 
                                       value="@field.Value" 
                                       placeholder="@field.Label" />
                            }
                        </div>
                    }
                }

                @if (Model.EnableSearch)
                {
                    <div class="col-md-4">
                        <label for="searchTerm" class="form-label">
                            <i class="bi bi-search me-1"></i>Search:
                        </label>
                        <div class="input-group">
                            <input type="text" 
                                   name="searchTerm" 
                                   id="searchTerm" 
                                   class="form-control" 
                                   value="@Model.SearchTerm" 
                                   placeholder="@Model.SearchPlaceholder"
                                   autocomplete="off" />
                            <button type="button" class="btn btn-outline-secondary" id="clearSearch" style="display: none;">
                                <i class="bi bi-x"></i>
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-search"></i> Search
                            </button>
                        </div>
                    </div>
                }

                @* Preserve other query parameters (including tab parameter) *@
                @foreach (var key in Context.Request.Query.Keys)
                {
                    @if (key != "searchTerm" && !Model.Fields.Any(f => f.Name == key))
                    {
                        <input type="hidden" name="@key" value="@Context.Request.Query[key]" />
                    }
                }
            </form>
        </div>
    </div>
}

<script>
    (function() {
        const filterForm = document.getElementById('filterForm');
        
        // Handle dropdown changes
        if (filterForm) {
            const dropdowns = filterForm.querySelectorAll('.filter-dropdown');
            dropdowns.forEach(function(dropdown) {
                const submitOnChange = dropdown.getAttribute('data-submit-on-change') === 'true';
                if (submitOnChange) {
                    dropdown.addEventListener('change', function() {
                        filterForm.submit();
                    });
                }
            });
        }

        // Handle search functionality
        @if (Model.EnableSearch)
        {
            <text>
            const searchInput = document.getElementById('searchTerm');
            const clearButton = document.getElementById('clearSearch');

            if (searchInput && clearButton) {
                // Show/hide clear button based on input
                searchInput.addEventListener('input', function() {
                    if (this.value.trim().length > 0) {
                        clearButton.style.display = 'block';
                    } else {
                        clearButton.style.display = 'none';
                    }
                });

                // Clear search
                clearButton.addEventListener('click', function() {
                    searchInput.value = '';
                    clearButton.style.display = 'none';
                    if (filterForm) {
                        filterForm.submit();
                    }
                });

                // Initialize clear button visibility
                if (searchInput.value.trim().length > 0) {
                    clearButton.style.display = 'block';
                }
            }
            </text>
        }
    })();
</script>

