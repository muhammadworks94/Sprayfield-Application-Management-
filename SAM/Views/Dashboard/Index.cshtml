@model SAM.ViewModels.Dashboard.DashboardViewModel
@using Microsoft.AspNetCore.Identity
@using SAM.Domain.Entities
@using System.Text.Json
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Dashboard";
    var isGlobalAdmin = ViewBag.IsGlobalAdmin as bool? ?? false;
    var user = await UserManager.GetUserAsync(User);
    var isAdmin = user != null && await UserManager.IsInRoleAsync(user, "admin");
    var isCompanyAdmin = user != null && await UserManager.IsInRoleAsync(user, "company_admin");
    var isTechnician = user != null && await UserManager.IsInRoleAsync(user, "technician");
    var isOperator = user != null && await UserManager.IsInRoleAsync(user, "operator");
    var canManageUsers = user != null && (await UserManager.IsInRoleAsync(user, "admin") || await UserManager.IsInRoleAsync(user, "company_admin"));
    var roleViewLabel = isAdmin
        ? "Global Admin View"
        : isCompanyAdmin
            ? "Company Admin View"
            : isTechnician
                ? "Technician View"
                : isOperator
                    ? "Operator View"
                    : null;
    var selectedCompanyName = ViewBag.SelectedCompanyName as string;
}

@if (isGlobalAdmin && !string.IsNullOrEmpty(selectedCompanyName))
{
    <div class="alert alert-info mb-3">
        <i class="bi bi-building me-2"></i>
        <strong>Viewing data for:</strong> @selectedCompanyName
    </div>
}

@section PageTitleExtra {
    @if (!string.IsNullOrEmpty(roleViewLabel))
    {
        <a asp-controller="Dashboard" asp-action="Index" class="text-primary small text-decoration-none">@roleViewLabel</a>
    }
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        @if (canManageUsers && Model.PendingUserRequests > 0)
        {
            <a asp-controller="UserManagement" asp-action="UserRequests" class="btn btn-warning">
                <i class="bi bi-exclamation-circle"></i> @Model.PendingUserRequests Pending User Request(s)
            </a>
        }
    </div>
</div>

<!-- Key Metric Cards (row 1) - pixel-perfect: icon top-right, title, value, subtitle -->
<div class="row g-3 mb-4">
    <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm h-100 border-0 rounded-3 dashboard-kpi-card">
            <div class="card-body">
                <div class="dashboard-kpi-icon bg-primary bg-opacity-10 rounded-3 p-2">
                    <i class="bi bi-building fs-5 text-primary"></i>
                </div>
                <div class="stat-label">Facilities</div>
                <div class="stat-value">@Model.TotalFacilities</div>
                <div class="stat-desc">Active treatment facilities</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm h-100 border-0 rounded-3 dashboard-kpi-card">
            <div class="card-body">
                <div class="dashboard-kpi-icon bg-success bg-opacity-10 rounded-3 p-2">
                    <i class="bi bi-grid-3x3-gap fs-5 text-success"></i>
                </div>
                <div class="stat-label">Sprayfields</div>
                <div class="stat-value">@Model.TotalSprayfields</div>
                <div class="stat-desc">@Model.TotalSprayfieldAcres.ToString("F1") total acres</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm h-100 border-0 rounded-3 dashboard-kpi-card">
            <div class="card-body">
                <div class="dashboard-kpi-icon bg-info bg-opacity-10 rounded-3 p-2">
                    <i class="bi bi-geo-alt fs-5 text-info"></i>
                </div>
                <div class="stat-label">Monitoring Wells</div>
                <div class="stat-value">@Model.TotalMonitoringWells</div>
                <div class="stat-desc">Groundwater monitoring points</div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-lg-3">
        <div class="card shadow-sm h-100 border-0 rounded-3 dashboard-kpi-card">
            <div class="card-body">
                <div class="dashboard-kpi-icon bg-warning bg-opacity-10 rounded-3 p-2">
                    <i class="bi bi-calendar3 fs-5 text-warning"></i>
                </div>
                <div class="stat-label">Recent Activity</div>
                <div class="stat-value">@Model.RecentActivityCount</div>
                <div class="stat-desc">Irrigation events (last 10)</div>
            </div>
        </div>
    </div>
</div>

<!-- Wastewater Trends + Groundwater Overview (row 2 - at top) - equal chart heights -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card dashboard-chart-card h-100">
            <div class="card-body">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-droplet me-2"></i>Wastewater Monitoring Trends
                </h5>
                <div class="dashboard-chart-wrap">
                    <canvas id="chartWastewaterTrends"></canvas>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-3 small">
                    <span class="d-inline-flex align-items-center gap-1">
                        <i class="bi bi-diamond text-danger"></i> Avg BOD5 (mg/L)
                    </span>
                    <span class="d-inline-flex align-items-center gap-1">
                        <i class="bi bi-circle-fill text-primary"></i> Avg TSS (mg/L)
                    </span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card dashboard-chart-card h-100">
            <div class="card-body">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-funnel me-2"></i>Groundwater Quality Overview
                </h5>
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <div class="dashboard-metric-box dashboard-metric-box-blue rounded-3 p-3">
                            <div class="text-muted small">Average pH</div>
                            <div class="fw-bold fs-4 text-primary">@(Model.GroundwaterOverview.AvgPH?.ToString("F2") ?? "—")</div>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="dashboard-metric-box dashboard-metric-box-green rounded-3 p-3">
                            <div class="text-muted small">Avg Conductivity (µS/cm)</div>
                            <div class="fw-bold fs-4 text-success">@(Model.GroundwaterOverview.AvgConductivity?.ToString("F0") ?? "—")</div>
                        </div>
                    </div>
                </div>
                <div class="dashboard-chart-wrap">
                    <canvas id="chartGroundwaterOverview"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Irrigation Compliance + Operational Efficiency (row 3) - equal chart heights -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card dashboard-chart-card h-100">
            <div class="card-body">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-check-circle text-success me-2"></i>Irrigation Compliance Status
                </h5>
                <div class="d-flex flex-column flex-md-row align-items-center justify-content-between">
                    <div class="dashboard-chart-wrap d-flex align-items-center justify-content-center flex-shrink-0">
                        <div class="position-relative" style="width: 180px; height: 180px;">
                            <canvas id="chartIrrigationCompliance" width="180" height="180"></canvas>
                            <div class="position-absolute top-50 start-50 translate-middle text-center">
                                <span class="fw-bold fs-6" style="color: #14b8a6;">Compliant @Model.IrrigationCompliance.CompliantPercent.ToString("F0")%</span>
                            </div>
                        </div>
                    </div>
                    <div class="dashboard-summary-box p-3 text-center ms-md-3 mt-3 mt-md-0">
                        <div class="text-muted small">Compliant</div>
                        <div class="fw-bold fs-4">@Model.IrrigationCompliance.CompliantCount</div>
                        <div class="text-muted small">(@Model.IrrigationCompliance.CompliantPercent.ToString("F0")%)</div>
                    </div>
                </div>
                <div class="mt-3 d-flex align-items-center gap-2">
                    <span class="d-inline-block rounded-1 dashboard-legend-normal" style="width: 12px; height: 12px;"></span>
                    <span class="small">Compliant</span>
                </div>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card dashboard-chart-card h-100">
            <div class="card-body">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-graph-up-arrow me-2"></i>Operational Efficiency Indicators
                </h5>
                <div class="dashboard-uptime-strip p-3 mb-3">
                    <div class="text-muted small">System Uptime</div>
                    <div class="fw-bold fs-4" style="color: #14b8a6;">@Model.SystemUptimePercent.ToString("F1")%</div>
                    <div class="text-muted small">Based on normal operational status</div>
                </div>
                <div class="dashboard-chart-wrap dashboard-chart-wrap-tall">
                    <canvas id="chartOperationalEfficiency"></canvas>
                </div>
                <div class="mt-2 d-flex flex-wrap gap-3 small">
                    <span class="d-inline-flex align-items-center gap-1">
                        <span class="rounded-1 dashboard-legend-normal" style="width: 10px; height: 10px;"></span> Normal
                    </span>
                    <span class="d-inline-flex align-items-center gap-1">
                        <span class="rounded-1 bg-warning" style="width: 10px; height: 10px;"></span> Alert
                    </span>
                    <span class="d-inline-flex align-items-center gap-1">
                        <span class="rounded-1 bg-info" style="width: 10px; height: 10px;"></span> Maintenance
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity + System Status (below the graphs) - pixel-perfect -->
<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card dashboard-chart-card h-100">
            <div class="card-body">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-journal-text me-2"></i>Recent Activity
                </h5>
                @if (Model.RecentActivities.Any())
                {
                    <ul class="list-unstyled mb-0">
                        @foreach (var activity in Model.RecentActivities)
                        {
                            <li class="d-flex justify-content-between align-items-start py-2 @(activity != Model.RecentActivities.Last() ? "border-bottom border-light" : "")">
                                <div class="flex-grow-1">
                                    <div class="fw-semibold text-dark">@activity.Description</div>
                                    <div class="small text-muted mt-1">@activity.Date.ToString("dd/MM/yyyy")</div>
                                </div>
                                <span class="dashboard-status-tag dashboard-status-tag-dark rounded px-2 py-1 small ms-2 flex-shrink-0">Completed</span>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p class="text-muted small mb-0">No recent activity</p>
                }
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card dashboard-chart-card h-100">
            <div class="card-body">
                <h5 class="fw-semibold mb-3">
                    <i class="bi bi-exclamation-triangle text-warning me-2"></i>System Status
                </h5>
                <ul class="list-unstyled mb-0">
                    @foreach (var sys in Model.SystemStatuses)
                    {
                        <li class="d-flex justify-content-between align-items-center py-2 @(sys != Model.SystemStatuses.Last() ? "border-bottom border-light" : "")">
                            <span class="text-dark">@sys.SystemName</span>
                            <span class="@(sys.IsNormalOrOperational ? "dashboard-status-tag-dark" : "dashboard-status-tag-light") dashboard-status-tag rounded px-2 py-1 small flex-shrink-0 ms-2">@sys.Status</span>
                        </li>
                    }
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            const primaryColor = '#2563eb';
            const dangerColor = '#dc3545';
            const warningColor = '#fd7e14';
            const infoColor = '#17a2b8';
            const successColor = '#28a745';
            const greenTeal = '#14b8a6';
            const greenTealDark = '#0d9488';

            document.addEventListener('DOMContentLoaded', function() {
                // 1. Irrigation Compliance (doughnut) - greenish-teal for Compliant
                const compliantPercent = @Model.IrrigationCompliance.CompliantPercent;
                const underReviewPercent = @Model.IrrigationCompliance.UnderReviewPercent;
                const nonCompliantPercent = @Model.IrrigationCompliance.NonCompliantPercent;
                const totalPie = compliantPercent + underReviewPercent + nonCompliantPercent;
                const pieData = totalPie > 0 ? [compliantPercent, underReviewPercent, nonCompliantPercent] : [100, 0, 0];
                new Chart(document.getElementById('chartIrrigationCompliance'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Compliant', 'Under Review', 'Non-Compliant'],
                        datasets: [{
                            data: pieData,
                            backgroundColor: [greenTeal, warningColor, dangerColor],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        cutout: '70%',
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });

                // 2. Operational Efficiency - vertical bar chart (2 dates, 2 tall green-teal bars, Y 0-1, dashed grid)
                let effDates = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OperationalEfficiencyByDate?.Select(x => x.DateLabel).ToList() ?? new List<string>()));
                let effValues = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OperationalEfficiencyByDate?.Select(x => x.Value).ToList() ?? new List<double>()));
                if (!effDates || effDates.length === 0) { effDates = ['No data', '—']; effValues = [0, 0]; }
                if (effDates.length === 1) { effDates.push('—'); effValues.push(1); }
                new Chart(document.getElementById('chartOperationalEfficiency'), {
                    type: 'bar',
                    data: {
                        labels: effDates,
                        datasets: [{
                            label: 'Uptime',
                            data: effValues,
                            backgroundColor: greenTeal,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        indexAxis: 'x',
                        scales: {
                            y: {
                                min: 0,
                                max: 1,
                                ticks: { stepSize: 0.25 },
                                grid: { color: 'rgba(0,0,0,0.08)', borderDash: [4, 2] }
                            },
                            x: {
                                grid: { display: true, color: 'rgba(0,0,0,0.08)', borderDash: [4, 2] }
                            }
                        },
                        plugins: { legend: { display: false } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // 3. Wastewater Trends (line) - fallback when no data
                let wwPeriods = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.WastewaterTrends?.Select(x => x.PeriodLabel).ToList() ?? new List<string>()));
                let wwBod5 = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.WastewaterTrends?.Select(x => x.AvgBOD5 ?? 0m).ToList() ?? new List<decimal>()));
                let wwTss = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.WastewaterTrends?.Select(x => x.AvgTSS ?? 0m).ToList() ?? new List<decimal>()));
                if (!wwPeriods || wwPeriods.length === 0) {
                    wwPeriods = ['No data'];
                    wwBod5 = [0];
                    wwTss = [0];
                }
                new Chart(document.getElementById('chartWastewaterTrends'), {
                    type: 'line',
                    data: {
                        labels: wwPeriods,
                        datasets: [
                            { label: 'Avg BOD5 (mg/L)', data: wwBod5, borderColor: dangerColor, backgroundColor: 'transparent', pointStyle: 'diamond', pointRadius: 5, tension: 0.2 },
                            { label: 'Avg TSS (mg/L)', data: wwTss, borderColor: primaryColor, backgroundColor: 'transparent', pointStyle: 'circle', pointRadius: 5, tension: 0.2 }
                        ]
                    },
                    options: {
                        scales: {
                            y: { min: 0, suggestedMax: 16, grid: { color: 'rgba(0,0,0,0.06)' } },
                            x: { grid: { color: 'rgba(0,0,0,0.06)' } }
                        },
                        plugins: { legend: { display: false } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });

                // 4. Groundwater Overview (bar by well) - fallback when no data
                let gwWells = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.GroundwaterOverview?.ByWell?.Select(x => x.WellId).ToList() ?? new List<string>()));
                let gwPh = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.GroundwaterOverview?.ByWell?.Select(x => x.PH ?? 0m).ToList() ?? new List<decimal>()));
                if (!gwWells || gwWells.length === 0) {
                    gwWells = ['No data'];
                    gwPh = [0];
                }
                new Chart(document.getElementById('chartGroundwaterOverview'), {
                    type: 'bar',
                    data: {
                        labels: gwWells,
                        datasets: [{ label: 'pH', data: gwPh, backgroundColor: primaryColor, borderWidth: 0 }]
                    },
                    options: {
                        indexAxis: 'x',
                        scales: {
                            y: { min: 0, max: 8, ticks: { stepSize: 2 }, grid: { color: 'rgba(0,0,0,0.06)' } },
                            x: { grid: { display: false } }
                        },
                        plugins: { legend: { display: false } },
                        responsive: true,
                        maintainAspectRatio: false
                    }
                });
            });
        })();
    </script>
}
