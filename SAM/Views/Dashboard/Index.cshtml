@model SAM.ViewModels.Dashboard.DashboardViewModel
@using Microsoft.AspNetCore.Identity
@using SAM.Domain.Entities
@inject UserManager<ApplicationUser> UserManager
@{
    ViewData["Title"] = "Dashboard";
    var isGlobalAdmin = ViewBag.IsGlobalAdmin as bool? ?? false;
    var user = await UserManager.GetUserAsync(User);
    var canManageUsers = user != null && (await UserManager.IsInRoleAsync(user, "admin") || await UserManager.IsInRoleAsync(user, "company_admin"));
}

<div class="d-flex justify-content-between align-items-center mb-4">
   
    <div>
        @if (canManageUsers && Model.PendingUserRequests > 0)
        {
            <a asp-controller="UserManagement" asp-action="UserRequests" class="btn btn-warning">
                <i class="bi bi-exclamation-circle"></i> @Model.PendingUserRequests Pending User Request(s)
            </a>
        }
        @if (isGlobalAdmin && Model.PendingAdminRequests > 0)
        {
            <a asp-controller="UserManagement" asp-action="AdminRequests" class="btn btn-warning">
                <i class="bi bi-exclamation-circle"></i> @Model.PendingAdminRequests Pending Admin Request(s)
            </a>
        }
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="stat-card stat-card-primary">
            <div class="stat-icon-container">
                <i class="bi bi-building stat-icon"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.TotalFacilities</div>
                <div class="stat-label">Facilities</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card stat-card-success">
            <div class="stat-icon-container">
                <i class="bi bi-grid-3x3-gap stat-icon"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.TotalSprayfields</div>
                <div class="stat-label">Sprayfields</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="stat-card stat-card-info">
            <div class="stat-icon-container">
                <i class="bi bi-droplet stat-icon"></i>
            </div>
            <div class="stat-content">
                <div class="stat-value">@Model.TotalMonitoringWells</div>
                <div class="stat-label">Monitoring Wells</div>
            </div>
        </div>
    </div>
    @if (isGlobalAdmin)
    {
        <div class="col-md-3">
            <div class="stat-card stat-card-warning">
                <div class="stat-icon-container">
                    <i class="bi bi-briefcase stat-icon"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-value">@Model.TotalCompanies</div>
                    <div class="stat-label">Companies</div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Compliance Status -->
@{
    var totalReports = Model.CompliantReports + Model.UnderReviewReports + Model.NonCompliantReports;
    var compliantPercent = totalReports > 0 ? (Model.CompliantReports * 100.0 / totalReports) : 0;
    var underReviewPercent = totalReports > 0 ? (Model.UnderReviewReports * 100.0 / totalReports) : 0;
    var nonCompliantPercent = totalReports > 0 ? (Model.NonCompliantReports * 100.0 / totalReports) : 0;
    
    // Calculate circumference for SVG (radius = 64, so circumference = 2 * PI * 64 â‰ˆ 402)
    var circumference = 2 * Math.PI * 64;
    var compliantOffset = circumference - (compliantPercent / 100 * circumference);
    var underReviewOffset = circumference - (underReviewPercent / 100 * circumference);
    var nonCompliantOffset = circumference - (nonCompliantPercent / 100 * circumference);
}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card card-primary">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-shield-check"></i> Compliance Status (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <div class="progress-circle-container">
                            <div class="progress-circle-wrapper">
                                <svg class="progress-circle-svg" viewBox="0 0 140 140">
                                    <circle class="progress-circle-bg" cx="70" cy="70" r="64"></circle>
                                    <circle class="progress-circle-fill compliant" 
                                            cx="70" cy="70" r="64"
                                            stroke-dasharray="@circumference"
                                            stroke-dashoffset="@compliantOffset"
                                            data-percent="@compliantPercent"></circle>
                                </svg>
                                <div class="progress-circle-value">@compliantPercent.ToString("F0")%</div>
                            </div>
                            <div class="progress-circle-count">@Model.CompliantReports</div>
                            <div class="progress-circle-label">Compliant Reports</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="progress-circle-container">
                            <div class="progress-circle-wrapper">
                                <svg class="progress-circle-svg" viewBox="0 0 140 140">
                                    <circle class="progress-circle-bg" cx="70" cy="70" r="64"></circle>
                                    <circle class="progress-circle-fill under-review" 
                                            cx="70" cy="70" r="64"
                                            stroke-dasharray="@circumference"
                                            stroke-dashoffset="@underReviewOffset"
                                            data-percent="@underReviewPercent"></circle>
                                </svg>
                                <div class="progress-circle-value">@underReviewPercent.ToString("F0")%</div>
                            </div>
                            <div class="progress-circle-count">@Model.UnderReviewReports</div>
                            <div class="progress-circle-label">Under Review</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="progress-circle-container">
                            <div class="progress-circle-wrapper">
                                <svg class="progress-circle-svg" viewBox="0 0 140 140">
                                    <circle class="progress-circle-bg" cx="70" cy="70" r="64"></circle>
                                    <circle class="progress-circle-fill non-compliant" 
                                            cx="70" cy="70" r="64"
                                            stroke-dasharray="@circumference"
                                            stroke-dashoffset="@nonCompliantOffset"
                                            data-percent="@nonCompliantPercent"></circle>
                                </svg>
                                <div class="progress-circle-value">@nonCompliantPercent.ToString("F0")%</div>
                            </div>
                            <div class="progress-circle-count">@Model.NonCompliantReports</div>
                            <div class="progress-circle-label">Non-Compliant Reports</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Activity and Compliance Summaries -->
<div class="row mb-4">
    <div class="col-md-6 mb-md-0">
        <div class="card card-warning h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock-history me-2"></i> Recent Activity</h5>
            </div>
            <div class="card-body">
                @if (Model.RecentActivities.Any())
                {
                    <div class="list-group list-group-flush">
                        @foreach (var activity in Model.RecentActivities)
                        {
                            <div class="list-group-item border-0 border-bottom px-0 py-3">
                                <div class="d-flex w-100 justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-2">
                                            <div class="me-2">
                                                <i class="bi bi-@(activity.Type == "Operator Log" ? "journal-text" : activity.Type == "Irrigation" ? "droplet" : "file-earmark-text") text-primary" style="font-size: 1.25rem;"></i>
                                            </div>
                                            <h6 class="mb-0 fw-semibold">@activity.Type</h6>
                                        </div>
                                        <p class="mb-2 text-muted small">@activity.Description</p>
                                        <small class="text-muted">
                                            <i class="bi bi-person me-1"></i>@activity.User
                                        </small>
                                    </div>
                                    <small class="text-muted ms-3 text-nowrap">@activity.Date.ToString("MM/dd/yyyy HH:mm")</small>
                                </div>
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--gray-400);"></i>
                        <p class="text-muted mt-3 mb-0">No recent activity</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card card-success h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-check me-2"></i> Recent Compliance Reports</h5>
            </div>
            <div class="card-body">
                @if (Model.ComplianceSummaries.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0">
                            <thead>
                                <tr>
                                    <th class="border-0"><i class="bi bi-building me-1"></i>Facility</th>
                                    <th class="border-0">Period</th>
                                    <th class="border-0 text-end">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var summary in Model.ComplianceSummaries)
                                {
                                    <tr>
                                        <td class="align-middle">
                                            <i class="bi bi-building me-1 text-muted"></i>@summary.FacilityName
                                        </td>
                                        <td class="align-middle text-muted">@summary.Period</td>
                                        <td class="align-middle text-end">
                                            <span class="badge badge-@(summary.ComplianceStatus == "Compliant" ? "success" : summary.ComplianceStatus == "NonCompliant" ? "danger" : "warning")">
                                                @summary.ComplianceStatus
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="bi bi-inbox" style="font-size: 3rem; color: var(--gray-400);"></i>
                        <p class="text-muted mt-3 mb-0">No compliance reports available</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Recent Data Entry -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card card-info">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Recent Data Entry (Last 30 Days)</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="metric-card-mini">
                            <div class="metric-card-mini-icon icon-primary">
                                <i class="bi bi-journal-text"></i>
                            </div>
                            <div class="metric-card-mini-content">
                                <div class="metric-card-mini-value">@Model.RecentOperatorLogs</div>
                                <div class="metric-card-mini-label">Operator Logs</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card-mini">
                            <div class="metric-card-mini-icon icon-success">
                                <i class="bi bi-droplet"></i>
                            </div>
                            <div class="metric-card-mini-content">
                                <div class="metric-card-mini-value">@Model.RecentIrrigations</div>
                                <div class="metric-card-mini-label">Irrigation Records</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card-mini">
                            <div class="metric-card-mini-icon icon-info">
                                <i class="bi bi-water"></i>
                            </div>
                            <div class="metric-card-mini-content">
                                <div class="metric-card-mini-value">@Model.RecentWWCharRecords</div>
                                <div class="metric-card-mini-label">Wastewater Records</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card-mini">
                            <div class="metric-card-mini-icon icon-warning">
                                <i class="bi bi-droplet-half"></i>
                            </div>
                            <div class="metric-card-mini-content">
                                <div class="metric-card-mini-value">@Model.RecentGWMonitRecords</div>
                                <div class="metric-card-mini-label">Groundwater Records</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Animate circular progress indicators on page load
        document.addEventListener('DOMContentLoaded', function() {
            const progressCircles = document.querySelectorAll('.progress-circle-fill');
            const circumference = 2 * Math.PI * 64;
            
            progressCircles.forEach(function(circle, index) {
                const percent = parseFloat(circle.getAttribute('data-percent')) || 0;
                const offset = circumference - (percent / 100 * circumference);
                
                // Reset to full circumference for animation start
                circle.style.strokeDashoffset = circumference;
                
                // Animate to target value with staggered delay
                setTimeout(function() {
                    circle.style.transition = 'stroke-dashoffset 1.2s ease-out';
                    circle.style.strokeDashoffset = offset;
                }, 150 + (index * 100));
            });
        });
    </script>
}

